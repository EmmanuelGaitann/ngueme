{% extends 'base_desktop.html' %}
{% load static %}

{% block title %}Journal{% endblock %}
{% block page_title %}Journal de caisse{% endblock %}

{% block content %}
<div style="display:grid;grid-template-columns:1fr 380px;gap:16px;align-items:start;">

  <!-- ── Liste transactions ── -->
  <div class="card" style="overflow:hidden;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
      <p class="serif" style="font-size:17px;font-weight:700;">
        Toutes les opérations
        <span style="font-size:13px;color:var(--ink3);font-family:'Plus Jakarta Sans',sans-serif;font-weight:500;margin-left:8px;">
          ({{ total_count }})
        </span>
      </p>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
        <form method="get" style="display:flex;gap:5px;align-items:center;flex-wrap:wrap;">
          <select class="fin-input" name="type" style="width:auto;font-size:12px;padding:6px 10px;" onchange="this.form.submit()">
            <option value="" {% if not type_filter %}selected{% endif %}>Tous</option>
            <option value="income"          {% if type_filter == 'income' %}selected{% endif %}>Revenus</option>
            <option value="expense"         {% if type_filter == 'expense' %}selected{% endif %}>Dépenses</option>
            <option value="planned_expense" {% if type_filter == 'planned_expense' %}selected{% endif %}>Planifiées</option>
          </select>
          <input type="date" class="fin-input" name="date_from" value="{{ date_from }}"
            style="width:138px;font-size:12px;padding:6px 8px;" title="Date de début">
          <input type="date" class="fin-input" name="date_to" value="{{ date_to }}"
            style="width:138px;font-size:12px;padding:6px 8px;" title="Date de fin">
          <button type="submit" style="height:34px;padding:0 12px;border-radius:8px;border:none;
            background:var(--indigo);color:#fff;cursor:pointer;font-size:12px;font-weight:700;" title="Filtrer">
            <i class="fa-solid fa-filter"></i>
          </button>
          {% if date_from or date_to %}
          <a href="{% url 'transactions:journal' %}{% if type_filter %}?type={{ type_filter }}{% endif %}"
            style="height:34px;padding:0 10px;border-radius:8px;background:var(--s2);color:var(--ink3);
            display:flex;align-items:center;font-size:12px;text-decoration:none;" title="Effacer les filtres de date">
            <i class="fa-solid fa-xmark"></i>
          </a>
          {% endif %}
        </form>
        <a href="{% url 'transactions:export_csv' %}?date_from={{ date_from }}&date_to={{ date_to }}"
           title="Exporter CSV" style="width:32px;height:32px;border-radius:8px;background:var(--forest-l);color:var(--forest);
           display:flex;align-items:center;justify-content:center;text-decoration:none;font-size:13px;">
          <i class="fa-solid fa-file-csv"></i>
        </a>
        <a href="{% url 'transactions:analyse' %}?date_from={{ date_from }}&date_to={{ date_to }}"
           title="Diagnostiquer la période" style="width:32px;height:32px;border-radius:8px;background:var(--indigo-l);color:var(--indigo);
           display:flex;align-items:center;justify-content:center;text-decoration:none;font-size:13px;">
          <i class="fa-solid fa-chart-pie"></i>
        </a>
      </div>
    </div>

    <div id="tx-list">
      {% for tx in transactions %}
      <div class="tx-row" data-type="{{ tx.type }}" data-id="{{ tx.id }}">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="tx-icon {{ tx.category.color_class|default:'ci-divers' }}">
            <i class="fa-solid {{ tx.category.icon|default:'fa-circle-dot' }}" style="font-size:13px;"></i>
          </div>
          <div>
            <p style="font-size:13px;font-weight:600;line-height:1.3;">
              {{ tx.description }}
              {% if tx.is_planned %}
              <span class="chip chip-amber" style="margin-left:5px;font-size:10px;">Planifié</span>
              {% endif %}
              {% if tx.source == 'sms' %}
              <span class="chip chip-indigo" style="margin-left:5px;font-size:10px;"><i class="fa-solid fa-comment-sms" style="font-size:8px;"></i> SMS</span>
              {% elif tx.source == 'ai' %}
              <span class="chip chip-indigo" style="margin-left:5px;font-size:10px;"><i class="fa-solid fa-brain" style="font-size:8px;"></i> IA</span>
              {% endif %}
            </p>
            <p style="font-size:11px;color:var(--ink3);margin-top:2px;">
              {{ tx.date|date:"d/m/Y" }} · {{ tx.category.name|default:"Divers" }}
            </p>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <p style="font-size:14px;font-weight:700;white-space:nowrap;
            color:{% if tx.is_expense %}var(--danger){% else %}var(--forest){% endif %};">
            {% if tx.is_expense %}−{% else %}+{% endif %}{{ tx.amount|floatformat:0 }} F
          </p>
          <button onclick="openEdit({{ tx.id }})"
            style="width:28px;height:28px;border-radius:7px;border:none;background:var(--indigo-l);
            color:var(--indigo);cursor:pointer;font-size:12px;" title="Modifier">
            <i class="fa-solid fa-pen"></i>
          </button>
          <button onclick="deleteTx({{ tx.id }}, this)"
            style="width:28px;height:28px;border-radius:7px;border:none;background:var(--s2);
            color:var(--ink3);cursor:pointer;font-size:12px;" title="Supprimer">
            <i class="fa-solid fa-trash-can"></i>
          </button>
        </div>
      </div>
      {% empty %}
      <div style="text-align:center;padding:40px 20px;color:var(--ink3);">
        <i class="fa-solid fa-receipt" style="font-size:32px;margin-bottom:12px;display:block;opacity:.3;"></i>
        <p style="font-size:14px;font-weight:500;">Aucune transaction encore</p>
        <p style="font-size:12px;margin-top:4px;">Commencez par coller un SMS ou saisir manuellement</p>
      </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if transactions.has_other_pages %}
    <div style="display:flex;align-items:center;justify-content:center;gap:6px;margin-top:16px;padding-top:14px;border-top:1px solid var(--border);">
      {% if transactions.has_previous %}
      <a href="?page={{ transactions.previous_page_number }}{% if type_filter %}&type={{ type_filter }}{% endif %}"
         style="padding:6px 12px;border-radius:7px;background:var(--s2);color:var(--ink2);font-size:12px;font-weight:600;text-decoration:none;">
        <i class="fa-solid fa-chevron-left"></i>
      </a>
      {% endif %}
      <span style="font-size:12px;color:var(--ink3);">
        Page {{ transactions.number }} / {{ transactions.paginator.num_pages }}
      </span>
      {% if transactions.has_next %}
      <a href="?page={{ transactions.next_page_number }}{% if type_filter %}&type={{ type_filter }}{% endif %}"
         style="padding:6px 12px;border-radius:7px;background:var(--s2);color:var(--ink2);font-size:12px;font-weight:600;text-decoration:none;">
        <i class="fa-solid fa-chevron-right"></i>
      </a>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- ── Formulaire ── -->
  <div style="display:flex;flex-direction:column;gap:14px;position:sticky;top:20px;">

    <!-- SMS Parser -->
    <div class="card" style="border-top:3px solid var(--forest);">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
        <div style="width:32px;height:32px;background:var(--forest-l);border-radius:8px;display:flex;align-items:center;justify-content:center;">
          <i class="fa-solid fa-comment-sms" style="color:var(--forest);font-size:13px;"></i>
        </div>
        <div>
          <p style="font-size:13px;font-weight:700;">Parser SMS Mobile Money</p>
          <p style="font-size:11px;color:var(--ink3);">MTN MoMo · Orange Money</p>
        </div>
      </div>
      <textarea class="fin-input" rows="3" id="sms-txt" style="margin-bottom:8px;resize:vertical;"
        placeholder="Collez votre SMS ici…
Ex: Vous avez reçu 25000 FCFA de DUPOND le 18/02/2026..."></textarea>
      <button onclick="doSMS()" class="btn-primary btn-forest" style="margin-bottom:10px;">
        <i class="fa-solid fa-bolt" style="margin-right:6px;"></i>Analyser le SMS
      </button>

      <div id="sms-result" style="display:none;background:var(--s2);border-radius:10px;padding:12px;">
        <p style="font-size:11px;font-weight:700;color:var(--forest);margin-bottom:8px;">
          <i class="fa-solid fa-circle-check" style="margin-right:4px;"></i>Transaction identifiée
        </p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;margin-bottom:10px;">
          <div><p class="field-label" style="margin-bottom:2px;">MONTANT</p><strong id="r-amount">—</strong></div>
          <div><p class="field-label" style="margin-bottom:2px;">TYPE</p><strong id="r-type">—</strong></div>
          <div><p class="field-label" style="margin-bottom:2px;">RÉSEAU</p><strong id="r-network">—</strong></div>
          <div><p class="field-label" style="margin-bottom:2px;">DATE</p><strong id="r-date">—</strong></div>
        </div>
        <div style="margin-bottom:8px;">
          <label class="field-label">CATÉGORIE</label>
          <select class="fin-input" id="sms-cat" style="font-size:12px;">
            {% for cat in categories %}
            <option value="{{ cat.slug }}">{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>
        <button onclick="addFromSMS()" class="btn-primary btn-forest">
          <i class="fa-solid fa-plus" style="margin-right:5px;"></i>Ajouter au journal
        </button>
      </div>
    </div>

    <!-- Saisie manuelle -->
    <div class="card" style="border-top:3px solid var(--sienna);">
      <p style="font-size:13px;font-weight:700;margin-bottom:14px;">
        <i class="fa-solid fa-pen-to-square" style="color:var(--sienna);margin-right:7px;"></i>Saisie manuelle
      </p>
      <form method="post" action="{% url 'transactions:add' %}" id="manual-form">
        {% csrf_token %}
        <div style="display:flex;flex-direction:column;gap:10px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div>
              <label class="field-label">MONTANT (FCFA)</label>
              <input class="fin-input" type="number" name="amount" id="f-amount" placeholder="25 000" min="1" required>
            </div>
            <div>
              <label class="field-label">TYPE</label>
              <select class="fin-input" name="type">
                <option value="expense">Dépense</option>
                <option value="income">Revenu</option>
                <option value="planned_expense">Dépense planifiée</option>
                <option value="planned_income">Revenu attendu</option>
              </select>
            </div>
          </div>
          <div>
            <label class="field-label">DESCRIPTION</label>
            <input class="fin-input" type="text" name="description" placeholder="Loyer, salaire, formation…" required>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div>
              <label class="field-label">CATÉGORIE</label>
              <select class="fin-input" name="category">
                {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label class="field-label">DATE</label>
              <input class="fin-input" type="date" name="date" id="f-date" required>
            </div>
          </div>
          <button type="submit" class="btn-primary btn-sienna">
            <i class="fa-solid fa-plus" style="margin-right:6px;"></i>Enregistrer
          </button>
        </div>
      </form>
    </div>

  </div>
</div>

<!-- ── Modal d'édition ── -->
<div id="edit-modal" style="display:none;position:fixed;inset:0;background:rgba(15,28,63,.55);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:var(--surface);border-radius:16px;padding:24px;width:440px;max-width:94vw;box-shadow:0 20px 60px rgba(0,0,0,.2);">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
      <p style="font-size:15px;font-weight:700;">
        <i class="fa-solid fa-pen" style="color:var(--indigo);margin-right:8px;"></i>Modifier la transaction
      </p>
      <button onclick="closeEdit()" style="width:30px;height:30px;border-radius:8px;border:none;background:var(--s2);cursor:pointer;font-size:14px;color:var(--ink3);">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <div>
          <label class="field-label">MONTANT (FCFA)</label>
          <input class="fin-input" type="number" id="edit-amount" min="1" required>
        </div>
        <div>
          <label class="field-label">TYPE</label>
          <select class="fin-input" id="edit-type">
            <option value="expense">Dépense</option>
            <option value="income">Revenu</option>
            <option value="planned_expense">Dépense planifiée</option>
            <option value="planned_income">Revenu attendu</option>
          </select>
        </div>
      </div>
      <div>
        <label class="field-label">DESCRIPTION</label>
        <input class="fin-input" type="text" id="edit-desc" required>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <div>
          <label class="field-label">CATÉGORIE</label>
          <select class="fin-input" id="edit-cat">
            <option value="">— Aucune —</option>
            {% for cat in categories %}
            <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="field-label">DATE</label>
          <input class="fin-input" type="date" id="edit-date" required>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:4px;">
        <button onclick="submitEdit()" class="btn-primary" style="background:var(--indigo);">
          <i class="fa-solid fa-floppy-disk" style="margin-right:6px;"></i>Enregistrer
        </button>
        <button onclick="closeEdit()" style="padding:10px 16px;border-radius:10px;border:none;background:var(--s2);color:var(--ink2);cursor:pointer;font-size:13px;font-weight:600;">
          Annuler
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const PARSE_URL  = "{% url 'transactions:parse_sms' %}";
const ADDSMS_URL = "{% url 'transactions:add_from_sms' %}";
const DELETE_URL = "{% url 'transactions:delete' pk=0 %}".replace('/0/', '/');
const EDIT_URL   = "{% url 'transactions:edit' pk=0 %}".replace('/0/', '/');

document.getElementById('f-date').value = new Date().toISOString().split('T')[0];

let smsData    = null;
let editTxId   = null;

async function doSMS() {
  const sms = document.getElementById('sms-txt').value.trim();
  if (!sms) { toast('Collez un SMS d\'abord', 'err'); return; }
  try {
    const r = await parseSMS(PARSE_URL, sms);
    if (r.status === 'ok') {
      smsData = r.data;
      document.getElementById('r-amount').textContent  = fmt(smsData.amount) + ' FCFA';
      document.getElementById('r-type').textContent    = smsData.type === 'income' ? 'Revenu' : 'Dépense';
      document.getElementById('r-network').textContent = smsData.network;
      document.getElementById('r-date').textContent    = smsData.date;
      document.getElementById('sms-result').style.display = 'block';
      toast('SMS analysé avec succès');
    } else {
      toast('SMS non reconnu — essayez la saisie manuelle', 'err');
    }
  } catch (e) { toast('Erreur réseau', 'err'); }
}

async function addFromSMS() {
  if (!smsData) return;
  smsData.category = document.getElementById('sms-cat').value;
  try {
    const r = await fetch(ADDSMS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf() },
      body: JSON.stringify(smsData)
    });
    const d = await r.json();
    if (d.status === 'ok') {
      toast('Transaction ajoutée depuis SMS');
      document.getElementById('sms-result').style.display = 'none';
      document.getElementById('sms-txt').value = '';
      smsData = null;
      setTimeout(() => location.reload(), 700);
    }
  } catch (e) { toast('Erreur lors de l\'ajout', 'err'); }
}

async function deleteTx(id, btn) {
  if (!confirm('Supprimer cette transaction ?')) return;
  const r = await fetch(DELETE_URL + id + '/', {
    method: 'POST',
    headers: { 'X-CSRFToken': getCsrf(), 'X-Requested-With': 'XMLHttpRequest' }
  });
  const d = await r.json();
  if (d.status === 'ok') {
    const row = btn.closest('.tx-row');
    row.style.opacity = '0';
    row.style.transition = '.3s';
    setTimeout(() => { row.remove(); toast('Transaction supprimée'); }, 300);
  }
}

async function openEdit(id) {
  editTxId = id;
  try {
    const r = await fetch(EDIT_URL + id + '/');
    const d = await r.json();
    document.getElementById('edit-amount').value = d.amount;
    document.getElementById('edit-type').value   = d.type;
    document.getElementById('edit-desc').value   = d.description;
    document.getElementById('edit-cat').value    = d.category || '';
    document.getElementById('edit-date').value   = d.date;
    const modal = document.getElementById('edit-modal');
    modal.style.display = 'flex';
  } catch (e) { toast('Impossible de charger la transaction', 'err'); }
}

function closeEdit() {
  document.getElementById('edit-modal').style.display = 'none';
  editTxId = null;
}

async function submitEdit() {
  if (!editTxId) return;
  const body = new URLSearchParams({
    amount:      document.getElementById('edit-amount').value,
    type:        document.getElementById('edit-type').value,
    description: document.getElementById('edit-desc').value,
    category:    document.getElementById('edit-cat').value,
    date:        document.getElementById('edit-date').value,
    csrfmiddlewaretoken: getCsrf(),
  });
  try {
    const r = await fetch(EDIT_URL + editTxId + '/', {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body,
    });
    const d = await r.json();
    if (d.status === 'ok') {
      toast('Transaction modifiée');
      closeEdit();
      setTimeout(() => location.reload(), 700);
    } else {
      toast('Erreur de validation', 'err');
    }
  } catch (e) { toast('Erreur réseau', 'err'); }
}

document.getElementById('edit-modal').addEventListener('click', function(e) {
  if (e.target === this) closeEdit();
});
</script>
{% endblock %}
