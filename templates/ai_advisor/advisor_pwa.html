{% extends 'base_pwa.html' %}
{% load static %}

{% block title %}Assistant IA{% endblock %}

{% block content %}
<div style="padding:10px 14px 80px;">

  <!-- Rapport IA -->
  <div class="card" style="margin-bottom:12px;padding:0;overflow:hidden;">
    <div style="background:linear-gradient(135deg,#0f1c3f,#1e3068);padding:16px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div style="display:flex;align-items:center;gap:9px;">
          <div style="width:34px;height:34px;background:rgba(255,255,255,.12);border-radius:9px;display:flex;align-items:center;justify-content:center;">
            <i class="fa-solid fa-brain" style="color:#fff;font-size:14px;"></i>
          </div>
          <div>
            <p style="font-size:13px;font-weight:700;color:#fff;">Rapport IA</p>
            <p style="font-size:10px;color:rgba(255,255,255,.5);">Semaine en cours</p>
          </div>
        </div>
        <button onclick="refreshReport()"
          style="padding:7px 11px;border-radius:8px;border:none;background:rgba(255,255,255,.1);
          color:#fff;font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;">
          <i class="fa-solid fa-rotate-right"></i> Régénérer
        </button>
      </div>
      <p style="font-size:10px;color:rgba(255,255,255,.4);letter-spacing:.07em;font-weight:700;margin-bottom:8px;">ANALYSE IA · SEMAINE EN COURS</p>
      <p style="font-size:12px;color:rgba(255,255,255,.85);line-height:1.75;" id="ai-report-text">{{ report }}</p>
    </div>
    <!-- Stat chips -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0;border-top:1px solid var(--border);">
      <div style="padding:12px 10px;text-align:center;border-right:1px solid var(--border);">
        <i class="fa-solid fa-circle-check" style="color:var(--forest);font-size:16px;margin-bottom:5px;display:block;"></i>
        <p style="font-size:10px;font-weight:700;color:var(--forest);">Budget</p>
        <p style="font-size:9px;color:var(--ink3);">respecté</p>
      </div>
      <div style="padding:12px 10px;text-align:center;border-right:1px solid var(--border);">
        <i class="fa-solid fa-faucet-drip" style="color:var(--amber);font-size:16px;margin-bottom:5px;display:block;"></i>
        <p style="font-size:10px;font-weight:700;color:var(--amber);">Fuites</p>
        <p style="font-size:9px;color:var(--ink3);">journal</p>
      </div>
      <div style="padding:12px 10px;text-align:center;">
        <i class="fa-solid fa-rocket" style="color:var(--indigo);font-size:16px;margin-bottom:5px;display:block;"></i>
        <p style="font-size:10px;font-weight:700;color:var(--indigo);">Opportunité</p>
        <p style="font-size:9px;color:var(--ink3);">BVMAC</p>
      </div>
    </div>
  </div>

  <!-- Prédictions 30 jours -->
  <div class="card" style="margin-bottom:12px;">
    <p style="font-size:13px;font-weight:700;margin-bottom:12px;">
      <i class="fa-solid fa-wand-magic-sparkles" style="color:var(--indigo);margin-right:7px;"></i>Prédictions — 30 jours
    </p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <div style="border:1.5px solid var(--border);border-radius:12px;padding:12px;">
        <p style="font-size:9px;color:var(--ink3);font-weight:700;letter-spacing:.06em;margin-bottom:5px;">SOLDE PRÉDIT</p>
        <p class="serif" style="font-size:17px;font-weight:700;">{{ predictions.predicted_balance|floatformat:0 }} F</p>
        <p style="font-size:10px;color:var(--forest);margin-top:3px;font-weight:600;">
          <i class="fa-solid fa-arrow-trend-up"></i>
          +{{ predictions.balance_change|default:0|floatformat:0 }} F
        </p>
      </div>
      <div style="border:1.5px solid var(--amber);border-radius:12px;padding:12px;background:var(--amber-l);">
        <p style="font-size:9px;color:var(--amber);font-weight:700;letter-spacing:.06em;margin-bottom:5px;">RISQUE BUDGET</p>
        <p class="serif" style="font-size:17px;font-weight:700;color:var(--amber);">{{ predictions.risk_level }}</p>
        <p style="font-size:10px;color:var(--ink3);margin-top:3px;">{{ predictions.risk_detail }}</p>
      </div>
    </div>
    <div style="border:1.5px solid var(--indigo);border-radius:12px;padding:12px;background:var(--indigo-l);margin-top:8px;">
      <p style="font-size:9px;color:var(--indigo);font-weight:700;letter-spacing:.06em;margin-bottom:5px;">MEILLEUR MOMENT D'INVESTISSEMENT</p>
      <p class="serif" style="font-size:17px;font-weight:700;color:var(--indigo);">{{ predictions.best_invest_date }}</p>
      <p style="font-size:10px;color:var(--ink3);margin-top:3px;">{{ predictions.best_invest_reason }}</p>
    </div>
  </div>

  <!-- Chat IA -->
  <div class="card" style="padding:0;overflow:hidden;">
    <div style="padding:14px 14px 10px;border-bottom:1px solid var(--s2);">
      <div style="display:flex;align-items:center;gap:8px;">
        <div style="width:32px;height:32px;background:linear-gradient(135deg,var(--indigo),var(--forest));border-radius:9px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <i class="fa-solid fa-robot" style="color:#fff;font-size:13px;"></i>
        </div>
        <div style="flex:1;">
          <p style="font-size:13px;font-weight:700;">Conseiller IA</p>
          <p style="font-size:10px;color:var(--ink3);">Posez n'importe quelle question</p>
        </div>
        <span style="padding:4px 8px;border-radius:6px;font-size:10px;font-weight:700;
          background:{% if has_api_key %}var(--forest-l){% else %}var(--amber-l){% endif %};
          color:{% if has_api_key %}var(--forest){% else %}var(--amber){% endif %};">
          {% if has_api_key %}Actif{% else %}Config.{% endif %}
        </span>
      </div>
    </div>

    <!-- Messages -->
    <div id="chat-msgs" style="height:280px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;padding:12px;">
      <div style="background:var(--s2);border-radius:12px 12px 12px 4px;padding:10px 12px;max-width:92%;">
        <p style="font-size:12px;color:var(--ink2);line-height:1.65;">
          Bonjour {{ user.first_name }} ! Je suis votre CFO autonome. Posez-moi une question — analyse de dépenses, simulation d'investissement, score financier, ou opportunités BVMAC.
        </p>
      </div>
      {% for msg in history %}
      <div style="{% if msg.role == 'user' %}background:var(--indigo);color:#fff;border-radius:12px 12px 4px 12px;align-self:flex-end;margin-left:15%;{% else %}background:var(--s2);border-radius:12px 12px 12px 4px;max-width:92%;{% endif %}padding:10px 12px;">
        <p style="font-size:12px;line-height:1.65;">{{ msg.content }}</p>
      </div>
      {% endfor %}
    </div>

    <!-- Input -->
    <div style="display:flex;gap:8px;padding:10px 12px 14px;border-top:1px solid var(--s2);">
      <input class="fin-input" type="text" id="chat-input"
        placeholder="Ex: Pourquoi mon score est 75 ?"
        onkeydown="if(event.key==='Enter')sendChat()"
        style="flex:1;font-size:13px;">
      <button onclick="sendChat()"
        style="width:40px;height:40px;background:var(--indigo);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:14px;flex-shrink:0;">
        <i class="fa-solid fa-paper-plane"></i>
      </button>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
const CHAT_URL    = "{% url 'ai_advisor:chat' %}";
const REFRESH_URL = "{% url 'ai_advisor:refresh_report' %}";
const CSRF_TOKEN  = "{{ csrf_token }}";

function sendChat() {
  const inp = document.getElementById('chat-input');
  const msg = inp.value.trim();
  if (!msg) return;
  addBubble(msg, 'user');
  inp.value = '';
  const loadId = addLoading();
  fetch(CHAT_URL, {
    method: 'POST',
    headers: {'Content-Type':'application/json','X-CSRFToken':CSRF_TOKEN},
    body: JSON.stringify({message: msg})
  })
  .then(r => r.json())
  .then(d => {
    document.getElementById(loadId).remove();
    addBubble(d.answer, 'assistant');
  })
  .catch(() => {
    document.getElementById(loadId).remove();
    addBubble('Erreur de connexion. Vérifiez votre clé API.', 'assistant');
  });
}

function addBubble(text, role) {
  const box = document.getElementById('chat-msgs');
  const div = document.createElement('div');
  div.style.cssText = role === 'user'
    ? 'background:var(--indigo);color:#fff;border-radius:12px 12px 4px 12px;align-self:flex-end;margin-left:15%;padding:10px 12px;'
    : 'background:var(--s2);border-radius:12px 12px 12px 4px;max-width:92%;padding:10px 12px;';
  div.innerHTML = `<p style="font-size:12px;line-height:1.65;">${text}</p>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function addLoading() {
  const id = 'load-' + Date.now();
  const box = document.getElementById('chat-msgs');
  const div = document.createElement('div');
  div.id = id;
  div.style.cssText = 'background:var(--s2);border-radius:12px;padding:10px 12px;max-width:92%;';
  div.innerHTML = '<p style="font-size:12px;color:var(--ink3);"><i class="fa-solid fa-circle-notch fa-spin"></i> Analyse en cours…</p>';
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
  return id;
}

function refreshReport() {
  const el = document.getElementById('ai-report-text');
  el.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Génération en cours…';
  fetch(REFRESH_URL, { method: 'GET', headers: {'X-CSRFToken': CSRF_TOKEN} })
  .then(r => r.json())
  .then(d => { el.textContent = d.report; });
}

// Scroll chat to bottom on load
document.getElementById('chat-msgs').scrollTop = document.getElementById('chat-msgs').scrollHeight;
</script>
{% endblock %}
